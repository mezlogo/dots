#!/bin/bash

pkgsList="$HOME/.config/pkgs.list"

diffPkgs() { comm -$1 -3 <(printInstalled) <(printDeclared) ; }

printDeclared() { [[ -z "$1" ]] && cat $pkgsList | cut -d ',' -f1 | sort || cat $pkgsList | grep -F $1 | cut -d ',' -f1 | sort ; }
printInstalled() { comm -23 <(pacman -Qqe | sort) <(pacman -Qqg base base-devel | sort) ; }

printNewDeclared() { diffPkgs 1 ; }
printNewUndeclared() { diffPkgs 2 ; }

removeUndeclared() { sudo pacman -Rns $(printNewUndeclared) ; }
installNewDeclared() { pakku -S --needed $(printNewDeclared) ; }

case "$1" in
  "printDeclared" | "pd") printDeclared "$2" ;;
  "printInstalled" | "pi") printInstalled ;;
  "printNewDeclared" | "pnd") printNewDeclared ;;
  "printNewUndeclared" | "pnu") printNewUndeclared ;;
  "export" | "e") printInstalled > $pkgsList ;;
  "removeUndeclared" | "rm") removeUndeclared ;;
  "installNewDeclared" | "i") installNewDeclared ;;
  "import")
    [[ ! -z $(printNewUndeclared) ]] && removeUndeclared || echo nothing to delete
    [[ ! -z $(printNewDeclared) ]] && installNewDeclared || echo nothing to install
    ;;
  "status" | *)  echo -e "new declared:\n------\n$(printNewDeclared)\n------\nnew undeclared:\n------\n$(printNewUndeclared)" ;;
esac
