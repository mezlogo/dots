#!/bin/bash

#pkgs: syncs package list between machines
#usage: `pkgs [list [{installed,declared}]]`
#pacman packages can be EXPLICITY installed and REQUIRED for some other package
#implicitly installed and orphan (not required for any package) packages must be removed
#commands:
#- print list
#- print explicitly installed
#- print explicitly installed, but not exported to list
#- print exported to list, but not installed
#- remove orphans AND caches
#- import: remove installed, but not exported to list AND install declared in list, but does not installed

pkgsList="$HOME/.config/pkgs.list"

diffPkgs() { comm -$1 -3 <(printInstalled) <(printList) ; }

printList() { cat $pkgsList | cut -d ',' -f1 | sort ; }
printInstalled() { comm -23 <(pacman -Qqe | sort) <(pacman -Qqg base base-devel | sort) ; }

printNotExported() { diffPkgs 1 ; }
printNotInstalled() { diffPkgs 2 ; }

removeNotInstalled() { sudo pacman -Rns $(printNotInstalled) ; }
installNewDeclared() { pakku -S --needed $(printNotExported) ; }

case "$1" in
  "printList" | "pl") printList ;;
  "printInstalled" | "pi") printInstalled ;;
  "printNotExported" | "pne") printNotExported ;;
  "printNotInstalled" | "pni") printNotInstalled ;;
  "export" | "e") printInstalled > $pkgsList ;;
  "removeNotInstalled" | "rm") removeNotInstalled ;;
  "installNewDeclared" | "i") installNewDeclared ;;
  "import")
    [[ ! -z $(printNotInstalled) ]] && removeNotInstalled || echo nothing to delete
    [[ ! -z $(printNotExported) ]] && installNewDeclared || echo nothing to install
    ;;
  "status" | *)  echo -e "explicitly installed, but not exported to list:\n------\n$(printNotExported)\n------\nexported to list, but not installed:\n------\n$(printNotInstalled)" ;;
esac
